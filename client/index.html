<!DOCTYPE HTML>
<!--
    CruzHacks 2019
-->

<html>

<head>
    <title>ChemisTRY</title>
    <meta charset="utf-8" />

    <!--First = A-Frame. Second AR.JS Thrid = axios-->
    <script src="https://aframe.io/releases/0.6.1/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.5.0/aframe/build/aframe-ar.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>

<body style='margin : 0px; overflow: hidden;'>
    <button style="z-index: 1;position: absolute;top: 0px;" onclick="buttonPress()">Click
        me</button>
    <a-scene embedded arjs>
        <a-marker preset="hiro" id="marker">
            <!-- <a-box color = "green" position = "0 0 0"></a-box> -->
        </a-marker>
        <a-entity camera></a-entity>
    </a-scene>


    <script>
        /* Global variables */
        var i = 0;
        var n = 10;

        var atomId = 0;
        var moleculeId = 0;
        
        /* List of molecules on screen*/
        function Molecule(name, posX, posY, posZ) {
            this.name = name;
            this.posX = posX;
            this.posY = posY;
            this.posZ = posZ
            this.atomList = [];
        }

        var moleculeList = [];
        /* Replace with axios request */
        addMolecule('glucose');

        addMolecule('oxygen');
        addMolecule('oxygen');
        addMolecule('oxygen');

        addMolecule('oxygen');
        addMolecule('oxygen');
        addMolecule('oxygen');

        /* Glucose (C6H12O6) Properties */
        var GLUCOSE_POSITIONS = [
            /* Carbons (0-5) */
            "-2.5 0 -.5",
            "-1.5 0 .5",
            "-.5 0 -.5",
            ".5 0 .5",
            "1.5 0 -.5",
            "2.5 0 .5",
            /* Oxygens (6-11) */
            "-2.5 0 -1.5",
            "-1.5 0 1.5",
            "-.5 0 -1.5",
            ".5 0 1.5",
            "1.5 0 -1.5",
            "2.5 0 1.5",
            /* Hydrogens (12-23) */
            "-2.75 0 -1.75",
            "-2.25 0 -1.75",
            "-1.75 0 1.75",
            "-1.25 0 1.75",
            "-.75 0 -1.75",
            "-.25 0 -1.75",
            ".75 0 1.75",
            ".25 0 1.75",
            "1.75 0 -1.75",
            "1.25 0 -1.75",
            "2.75 0 1.75",
            "2.25 0 1.75",
        ];
        var GLUCOSE_SCALE = 1;

        /* Oxygen (O2) Properties */
        var OXYGEN_POSITIONS = [
            /* Oxygens (0-1) */
            "-.5 0 0",
            ".5 0 0"
        ];
        var OXYGEN_SCALE = 1;

        /* Carbon Dioxide (CO2) Properties */
        var CARBON_DIOXIDE_POSITIONS = [
            /* Carbon (0) */
            "0 0 0",
            /* Oxygens (1-2) */
            "-.5 0 .5",
            ".5 0 .5",
        ]
        var CARBON_DIOXIDE_SCALE = 1;

        /* WATER (H2O) Properties */
        var WATER_POSITIONS = [
            /* Oxygen (0) */
            "0 0 0",
            /* Hydrogens (1-2) */
            "-.5 0 .5",
            ".5 0 .5",
        ]
        var WATER_SCALE = 1;


        function buttonPress() {
            reassignElements(0);
        }

        function addMolecule(molecule) {
            moleculeList.push(new Molecule(molecule, Math.random() * 5 - 2.5, 0, Math.random() * 5 - 2.5));
            switch (moleculeList[moleculeId].name) {
                case 'glucose':
                    addAtoms('carbon', 6);
                    addAtoms('oxygen', 6);
                    addAtoms('hydrogen', 12);
                    break;
                case 'water':
                    addAtoms('oxygen', 1);
                    addAtoms('hydrogen', 2);
                    break;
                case 'oxygen':
                    addAtoms('oxygen', 2);
                    break;
            }
            moleculeId++;
        }
        function addAtoms(atom, number) {
            for (var i = 0; i < number; i++) {
                addAtom(atom);
            }
        }
        function addAtom(atom) {
            moleculeList[moleculeId].atomList.push(atomId);
            $("#marker").append(
                '<a-sphere id =\"' + "id" + (atomId++) + '\"color = "' + getColorOfAtom(atom) + '" position = "0 0 0" radius = \"' + getRadiusOfAtom(atom) / 6 + '\"></a-box>'
            );
        }
        function getColorOfAtom(atom) {
            switch (atom) {
                case 'carbon': return "black";
                case 'oxygen': return "red";
                case 'hydrogen': return "white";
            }
        }
        function getRadiusOfAtom(atom) {
            switch (atom) {
                case 'carbon': return .8;
                case 'oxygen': return .6;
                case 'hydrogen': return .4;
            }
        }

        function calcPosChange(pos, targetPos) {
            if (Math.abs(pos - targetPos) > .01) {
                pos -= (pos - targetPos) * 0.05;
            }
            return pos;
        }

        /* Animate particles to calculated positions */
        setInterval(function () {
            for (var i = 0; i < atomId; i++) {
                var moleculeId = getMoleculeIndexFromId(i);
                if (moleculeId != -1) {
                    var moleculePosition = [moleculeList[moleculeId].posX, moleculeList[moleculeId].posY, moleculeList[moleculeId].posZ];
                    var element = document.getElementById("id" + i);
                    if (element != null) {
                        var position = (document.getElementById("id" + i).getAttribute("position"));
                        var targetPosition = calcTargetPosition(moleculePosition, i);
                        document.getElementById("id" + i).setAttribute("position", calcPosChange(position.x, targetPosition[0]) + " 0 " + calcPosChange(position.z, targetPosition[2]));
                    }
                }
            }
        }, 10);

        function getMoleculeFromId(elementNumber) {
            for (var i = 0; i < moleculeId; i++) {
                if (moleculeList[i].atomList != null) {
                    for (var j = 0; j < moleculeList[i].atomList.length; j++) {
                        if (moleculeList[i].atomList[j] == elementNumber) {
                            return moleculeList[i].name;
                        }
                    }
                }
            }
            return "not found";
        }
        function getAtomIndexFromId(elementNumber) {

            for (var i = 0; i < moleculeId; i++) {
                if (moleculeList[i].atomList != null) {
                    for (var j = 0; j < moleculeList[i].atomList.length; j++) {
                        if (moleculeList[i].atomList[j] == elementNumber) {
                            return j;
                        }
                    }
                }
            }
            return -1;
        }
        function getMoleculeIndexFromId(elementNumber) {
            for (var i = 0; i < moleculeId; i++) {
                if (moleculeList[i].atomList != null) {
                    for (var j = 0; j < moleculeList[i].atomList.length; j++) {
                        if (moleculeList[i].atomList[j] == elementNumber) {
                            return i;
                        }
                    }
                }
            }
            return -1;
        }


        function calcTargetPosition(moleculePosition, elementNumber) {
            var targetPosition = [];
            var molecule_type = getMoleculeFromId(elementNumber);
            var molecule_element_index = getAtomIndexFromId(elementNumber);
            switch (molecule_type) {
                case 'glucose':
                    var offSet = GLUCOSE_POSITIONS[molecule_element_index].split(" ");
                    break;
                case 'oxygen':
                    var offSet = OXYGEN_POSITIONS[molecule_element_index].split(" ");
                    break;
                case 'water':
                    var offSet = WATER_POSITIONS[molecule_element_index].split(" ");
                    break;
                case 'carbon_dioxide':
                    var offSet = CARBON_DIOXIDE_POSITIONS[molecule_element_index].split(" ");
                    break;
            }
            targetPosition[0] = moleculePosition[0] + parseFloat(offSet[0]) / 5;
            targetPosition[1] = 0;
            targetPosition[2] = moleculePosition[2] + parseFloat(offSet[2]) / 5;
            return targetPosition;
        }

        function reassignElements(moleculeIndex) {
            brokenMolecule = moleculeList[moleculeIndex];
            switch (brokenMolecule.name) {
                case ('glucose'):
                    for (var water = 0; water < 6; water++) {
                        /* Break off water molecules */
                        moleculeList.push(new Molecule('water', Math.random() * 5 - 2.5, 0, Math.random() * 5 - 2.5));
                        moleculeList[moleculeId].atomList.push(brokenMolecule.atomList[6 + water]);
                        moleculeList[moleculeId].atomList.push(brokenMolecule.atomList[(6 + water) * 2]);
                        moleculeList[moleculeId].atomList.push(brokenMolecule.atomList[(6 + water) * 2 + 1]);
                        moleculeId++;
                    }
                    for (var carbon = 0; carbon < 6; carbon++) {
                        moleculeList.push(new Molecule('carbon_dioxide', Math.random() * 5 - 2.5, 0, Math.random() * 5 - 2.5));
                        moleculeList[moleculeId].atomList.push(brokenMolecule.atomList[carbon]);
                        /* Find oxygen to combine with */
                        for (var molecule = 0; molecule < moleculeList.length; molecule++) {
                            if (moleculeList[molecule].name == 'oxygen' && moleculeList[molecule].atomList != null) {
                                moleculeList[moleculeId].atomList.push(moleculeList[molecule].atomList[0]);
                                moleculeList[moleculeId].atomList.push(moleculeList[molecule].atomList[1]);
                                moleculeList[molecule].atomList = null;
                                break;
                            }
                        }
                        moleculeId++;
                    }
                    moleculeList[moleculeIndex].atomList = null;
                    break;
                case ('water'):
                    break;
                case ('plutonium'):
                    break;
            }
        }

        axios.get('/api/data/').then(function (json) {
            //Build Function gets called or I can have it in here.
            console.log(json);
            console.log(json.data);
            // buildMolecule(symbol);
        }).catch(function (error) {
            console.log(error);
        });

    </script>
</body>

</html>